<html>
<head>
<link rel="stylesheet" type="text/css" href="arduino-style.css" />
<link rel='alternate' type='application/atom+xml' href='/feed.xml' title='New content'>
</head>
<body>
<!-- vim:set syntax=mkd: -->

<h1>Arduino on the command line</h1>

<p>I&#8217;ve lately been trying to compile Arduino projects from command line. Primarily
because the Arduino IDE wasn&#8217;t working out of the box on 64-bit Ubuntu (9.04). That problem
was eventually <a href="http://www.arduino.cc/cgi-bin/yabb2/YaBB.pl?num=1239099636/12#12">solved</a>,
but I&#8217;ve been meaning to move away from that IDE anyway.</p>

<p>After reading <em>a lot</em> of posts I finally ended up with a working solution.</p>

<p>In addition to <a href="http://arduino.cc/en/Main/Software">arduino</a> (for 32-bit linux),
you need to get a couple of packages:</p>

<pre><code>sudo apt-get install avg-gcc
sudo apt-get install avr-libc
sudo apt-get install python-serial
</code></pre>

<p>You&#8217;ll find hardware/cores/arduino/Makefile under the Arduino folder. This one is meant to
serve as a basis for your own projects. I had to make some modifications to it, in addition to what
was described in the file. You can get my <a href="arduino-command-line/Makefile">Makefile</a>, which
basically just splits the <code>$AVT_TOOLS_PATH</code> into two separate paths.</p>

<p>A key point that was hard to figure out, was that the Arduino needs to be reset right before
a program is uploaded. This is automatically done by the IDE, but not by the Makefile. If this
is not in place, you&#8217;ll get error messages like:</p>

<pre><code>stk500_recv(): programmer is not responding
</code></pre>

<p>or</p>

<pre><code>avrdude: stk500_getsync(): not in sync: resp=0x16
avrdude: stk500_disable(): protocol error, expect=0x14, resp=0x34
</code></pre>

<p>I made a tiny python script to reset the arduino:</p>

<pre><code>import serial
import time
import sys

if len(sys.argv) != 2:
    print "Please specify a port, e.g. %s /dev/ttyUSB0" % sys.argv[0]
    sys.exit(-1)

ser = serial.Serial(sys.argv[1])
ser.setDTR(1)
time.sleep(0.5)
ser.setDTR(0)
ser.close()
</code></pre>

<p>Save this as pulsedtr.py, move it to somewhere in your $PATH and do <code>chmod u+x pulsedtr.py</code>,
then place it in the Makefile under upload (Make sure you replace spaces with tabs if you copy
from below):</p>

<pre><code>upload: applet/$(TARGET).hex
    pulsedtr.py $(PORT)
    $(AVRDUDE) $(AVRDUDE_FLAGS) $(AVRDUDE_WRITE_FLASH)
</code></pre>

<p>This was all that was needed for me to be able to <code>make upload</code>. Let me know if you have any problems.</p>

<p><strong>Update:</strong> After using the Makefile for a little while, I realized that the dependencies are a bit wrong.
This is fixed now.</p>

<p><strong>Update:</strong> If you happen to be replacing the Arduino IDE with Vim, I just uploaded an
<a href="http://www.vim.org/scripts/script.php?script_id=2654">Arduino syntax file</a>.</p>
<p class="footer">
Johannes Hoff, johannes at johanneshoff.com, 2009-05-23
</p>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3865201-3']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>
